C51 COMPILER V9.00   MAIN                                                                  05/08/2016 11:05:34 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c COMPACT ROM(COMPACT) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /**
   2          **      FINDBAKE MAIN C FILE
   3          **
   4          **      TODO:
   5          **               run program at the first       
   6          **
   7          **      @luodongseu     github.com/luodongseu    2016/5/6
   8          **/
   9          
  10          //
  11          // 模块接口实现说明：
  12          //                                       串口1：GPRS模块（接收和发送数据）
  13          //                                       串口2：GPS模块 （接收GPS数据）
  14          //
  15          //
  16          
  17          /*************** 用户定义参数 *****************************/
  18          
  19          #define MAIN_Fosc       22118400L       //define main clock
  20          
  21          #define Baudrate1       9600            //define the baudrate, 如果使用BRT做波特率发生器,则波特率跟串口2一样
  22                                                                                  //12T mode: 600~115200 for 22.1184MHZ, 300~57600 for 11.0592MHZ
  23          
  24          #define Baudrate2       19200           //define the baudrate2,
  25                                                                                  //12T mode: 600~115200 for 22.1184MHZ, 300~57600 for 11.0592MHZ
  26          
  27          #define BUF_LENTH       128                     //定义串口接收缓冲长度
  28          
  29          /**********************************************************/
  30          
  31          #include        <reg51.h>
  32          #include        "GPS.h"
  33          #include        "GPRS.h"
  34          
  35          sfr AUXR1 = 0xA2;
  36          sfr     AUXR  = 0x8E;
  37          sfr S2CON = 0x9A;       //12C5A60S2双串口系列
  38          sfr S2BUF = 0x9B;       //12C5A60S2双串口系列
  39          sfr IE2   = 0xAF;       //STC12C5A60S2系列
  40          sfr BRT   = 0x9C;
  41          
  42          //串口1读写
  43          unsigned char   uart1_wr;               //写指针
  44          unsigned char   uart1_rd;               //读指针
  45          unsigned char   xdata RX1_Buffer[BUF_LENTH];
  46          bit             B_TI;
  47          
  48          //串口2读写
  49          unsigned char   uart2_wr;               //写指针
  50          unsigned char   uart2_rd;               //读指针
  51          unsigned char   xdata RX2_Buffer[BUF_LENTH];
  52          bit             B_TI2;
  53          
  54          /****************** 编译器自动生成，用户请勿修改 ************************************/
C51 COMPILER V9.00   MAIN                                                                  05/08/2016 11:05:34 PAGE 2   

  55          
  56          #define T1_TimerReload  (256 - MAIN_Fosc / 192 / Baudrate1)                     //Calculate the timer1 reload value     at 12T mo
             -de
  57          #define BRT_Reload              (256 - MAIN_Fosc / 12 / 16 / Baudrate2)         //Calculate BRT reload value
  58          
  59          #define TimeOut1                (28800 / (unsigned long)Baudrate1 + 2)
  60          #define TimeOut2                (28800 / (unsigned long)Baudrate2 + 2)
  61          
  62          #define TI2                             (S2CON & 0x02) != 0
  63          #define RI2                             (S2CON & 0x01) != 0
  64          #define CLR_TI2()               S2CON &= ~0x02
  65          #define CLR_RI2()               S2CON &= ~0x01
  66          
  67          /**********************************************************/
  68          
  69          
  70          //GPRS串口初始化
  71          void    GPRS_init(void)
  72          {
  73   1              PCON |= 0x80;           //UART0 Double Rate Enable
  74   1              SCON = 0x50;            //UART0 set as 10bit , UART0 RX enable
  75   1              TMOD &= ~(1<<6);                //Timer1 Set as Timer, 12T
  76   1              TMOD = (TMOD & ~0x30) | 0x20;   //Timer1 set as 8 bits auto relaod
  77   1              TH1 = T1_TimerReload;           //Load the timer
  78   1              TR1  = 1;
  79   1              ES  = 1;
  80   1              EA = 1;
  81   1      }
  82          
  83          //GPS串口初始化
  84          void    GPS_init(void)
  85          {
  86   1              AUXR1 |= (1<<4);        //将UART2从P1口切换到 RXD2--P1.2切换到P4.2   TXD2---P1.3切换到P4.3
  87   1              AUXR |=  (1 << 3);              //串口2波特率加倍
  88   1              //S2CON  = (S2CON & 0x3f) | (1<<6);     //串口2模式1，8位UART，(2^S2SMOD / 32) * BRT溢出率
  89   1              //S2CON |= 1 << 4;              //允许串2接收
  90   1              S2CON = 0x50;   //串口2工作在方式1  10位异步收发 S2REN=1允许接收
  91   1      
  92   1              AUXR |=  1 << 4;        //baudrate use BRT
  93   1              BRT = BRT_Reload;
  94   1      
  95   1              IE2 |=  1;                      //允许串口2中断
  96   1      }
  97          
  98          
  99          //GPRS口发送数据
 100          void    GPRS_TxByte(unsigned char dat)
 101          {
 102   1              //B_TI = 0;
 103   1              SBUF = dat;
 104   1              //while(!B_TI);
 105   1              //B_TI = 0;
 106   1      }
 107          
 108          //GPRS口发送一串字符串
 109          void GPRSTxString(unsigned char code *puts)             
 110          {
 111   1          for (; *puts != 0;  puts++)  GPRS_TxByte(*puts);    //遇到停止符0结束
 112   1      }
 113          
 114          
 115          /**
C51 COMPILER V9.00   MAIN                                                                  05/08/2016 11:05:34 PAGE 3   

 116          串口1中断响应
 117          *************
 118          接收GPRS数据
 119          *************
 120          对应--GPRS模块
 121          *************
 122          **/
 123          void GPRS_RCV (void) interrupt 4
 124          {
 125   1              if(RI)
 126   1              {
 127   2                      RI = 0;
 128   2      
 129   2                      RX2_Buffer[uart2_wr] = SBUF;
 130   2                      if(++uart2_wr >= BUF_LENTH)     uart2_wr = 0;
 131   2      
 132   2                      RX1_Buffer[uart1_wr] = SBUF;
 133   2                      if(++uart1_wr >= BUF_LENTH)     uart1_wr = 0;
 134   2              }
 135   1      
 136   1              if(TI)
 137   1              {
 138   2                      TI = 0;
 139   2                      B_TI = 1;
 140   2              }
 141   1      }
 142          
 143          /**
 144          串口1中断响应
 145          *************
 146          接收GPS数据
 147          *************
 148          对应--GPS模块
 149          *************
 150          **/
 151          void GPS_RCV (void) interrupt 8
 152          {
 153   1              if(RI2)
 154   1              {       
 155   2                      CLR_RI2();
 156   2                      //UART1_TxByte(S2BUF);  
 157   2                      RX1_Buffer[uart1_wr] = S2BUF;
 158   2                      if(++uart1_wr >= BUF_LENTH)     uart1_wr = 0;
 159   2              }
 160   1      
 161   1              if(TI2)
 162   1              {
 163   2                      CLR_TI2();
 164   2                      B_TI2 = 1;
 165   2              }
 166   1      }
 167          
 168          
 169          //入口主函数
 170          void main(){
 171   1              uart1_rd = 0;
 172   1              uart1_wr = 0;
 173   1              uart2_rd = 0;
 174   1              uart2_wr = 0;
 175   1      
 176   1              GPRS_init();
 177   1              GPS_init();
C51 COMPILER V9.00   MAIN                                                                  05/08/2016 11:05:34 PAGE 4   

 178   1      
 179   1              GPRSTxString("串口1--GPRS");
 180   1      
 181   1              while(1)
 182   1              {
 183   2                      if(uart1_rd != uart1_wr)        //串口1转发
 184   2                      {
 185   3                              GPRS_TxByte(RX1_Buffer[uart1_rd]);                //发送数据
 186   3                              if(++uart1_rd >= BUF_LENTH)             uart1_rd = 0;
 187   3                      }
 188   2      
 189   2                      if(uart2_rd != uart2_wr)        //串口2转发
 190   2                      {
 191   3                              //GPS_TxByte(RX2_Buffer[uart2_rd]);
 192   3                              //if(++uart2_rd >= BUF_LENTH)           uart2_rd = 0;
 193   3                      }
 194   2              }
 195   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    289    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =    256    ----
   PDATA SIZE       =      4    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
